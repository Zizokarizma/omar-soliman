<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ± ğŸ“Š</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f6f9; margin: 0; padding: 20px; }
        .header { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card-container { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .card { background: white; flex: 1; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: center; min-width: 200px; }
        .card h3 { margin: 0; color: #666; font-size: 16px; }
        .card h1 { margin: 10px 0 0; color: #2c3e50; font-size: 32px; }
        .chart-container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .logout-btn { background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        .blue { border-top: 4px solid #3498db; }
        .green { border-top: 4px solid #2ecc71; }
        .purple { border-top: 4px solid #9b59b6; }
        
        /* Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¹Ø§Ø¦Ù… (Ù†ÙØ³ Ø³ØªØ§ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©) */
        #floatingTimer { position: fixed; top: 20px; left: 20px; background: #2c3e50; color: #fff; padding: 8px 15px; border-radius: 25px; font-family: monospace; font-size: 18px; font-weight: bold; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 900; display: flex; align-items: center; gap: 8px; border: 2px solid transparent; transition: all 0.3s; }
    </style>
</head>
<body>

    <div id="floatingTimer">
        <span>â±ï¸</span> <span id="timeDisplay">30:00</span>
    </div>

    <div class="header">
        <h2>ğŸ‘‹ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø£ÙŠÙ‡Ø§ Ø§Ù„Ù…Ø¯ÙŠØ±</h2>
        <button class="logout-btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>

    <div class="card-container">
        <div class="card blue">
            <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
            <h1 id="totalStudents">...</h1>
        </div>
        <div class="card green">
            <h3>Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h3>
            <h1 id="todayIncome">...</h1>
        </div>
        <div class="card purple">
            <h3>Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ù‡Ø±</h3>
            <h1 id="monthIncome">...</h1>
        </div>
    </div>

    <div class="chart-container">
        <canvas id="incomeChart" height="100"></canvas>
    </div>

    <div id="timeoutWarning" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; justify-content: center; align-items: center;">
        <div style="background: white; padding: 40px; border-radius: 15px; text-align: center; border: 4px solid #dc3545; width: 320px;">
            <h1 style="font-size: 60px; margin: 0;">â³</h1>
            <h2 style="color: #dc3545; margin: 10px 0;">Ø§Ù†ØªØ¨Ù‡!</h2>
            <p style="font-size: 18px;">Ø³ØªÙ†ØªÙ‡ÙŠ Ø§Ù„Ø¬Ù„Ø³Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø®Ù„Ø§Ù„:</p>
            <h2 id="countdownTimer" style="font-size: 50px; color: #333; margin: 10px 0; font-family: monospace;">60</h2>
            <p style="font-size: 14px; color: #777;">Ø«Ø§Ù†ÙŠØ©</p>
        </div>
    </div>

    <script>
        // ğŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø¶Ø¹ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ù†Ø§)
        const DASHBOARD_API = "https://n8ncourse.online/webhook-test/dashboard-stats"; // âš ï¸ Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ø§ Ø¨Ø±Ø§Ø¨Ø·Ùƒ

        // ğŸ›¡ï¸ Ø§Ù„Ø­Ù…Ø§ÙŠØ© ÙˆØ§Ù„ÙˆÙ‚Øª
        const role = sessionStorage.getItem("user_role");
        const startTime = sessionStorage.getItem("session_start");
        if (role !== "admin" || !startTime) { window.location.href = "login.html"; }

        const SESSION_DURATION = 30 * 60 * 1000; 
        const WARNING_TIME = 60 * 1000;          
        const ALERT_SOUND_TIME = 15 * 1000;      
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playWarningBeep() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.type = 'square'; oscillator.frequency.setValueAtTime(800, audioCtx.currentTime); oscillator.frequency.exponentialRampToValueAtTime(400, audioCtx.currentTime + 0.1);
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime); gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            oscillator.connect(gainNode); gainNode.connect(audioCtx.destination); oscillator.start(); oscillator.stop(audioCtx.currentTime + 0.2);
        }

        function checkSession() {
            const now = Date.now();
            const remainingTime = SESSION_DURATION - (now - startTime);

            if (remainingTime > 0) {
                const minutes = Math.floor(remainingTime / 60000);
                const seconds = Math.floor((remainingTime % 60000) / 1000);
                document.getElementById('timeDisplay').innerText = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                const timerEl = document.getElementById('floatingTimer');
                if (remainingTime < 5 * 60 * 1000) { timerEl.style.backgroundColor = '#c0392b'; timerEl.style.border = '2px solid #e74c3c'; } 
                else { timerEl.style.backgroundColor = '#2c3e50'; timerEl.style.border = '2px solid transparent'; }
            }

            if (remainingTime <= 0) {
                sessionStorage.clear(); alert("ğŸ›‘ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø©."); window.location.href = "login.html";
            } else if (remainingTime <= WARNING_TIME) {
                document.getElementById('timeoutWarning').style.display = 'flex';
                document.getElementById('countdownTimer').innerText = Math.ceil(remainingTime / 1000);
                if (remainingTime <= ALERT_SOUND_TIME) playWarningBeep();
            }
        }
        setInterval(checkSession, 1000);
        checkSession();

        function logout() { if(confirm("ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ØŸ")) { sessionStorage.clear(); window.location.href = "login.html"; } }

        // ==========================================
        // ğŸ“Š Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¹Ø±Ø¶Ù‡Ø§
        // ==========================================
        let myChart;

        async function loadDashboardData() {
            try {
                const res = await fetch(DASHBOARD_API);
                const data = await res.json(); // Ø³ÙŠØ£ØªÙŠ JSON Ù…Ù† Supabase Ù…Ø¨Ø§Ø´Ø±Ø©

                // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
                document.getElementById('totalStudents').innerText = data.total_students || 0;
                document.getElementById('todayIncome').innerText = (data.today_income || 0) + " Ø¬.Ù…";
                document.getElementById('monthIncome').innerText = (data.month_income || 0) + " Ø¬.Ù…";

                // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
                const labels = data.chart_data.map(d => d.day_name.trim()); // Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£ÙŠØ§Ù…
                const values = data.chart_data.map(d => d.total); // Ø§Ù„Ù…Ø¨Ø§Ù„Øº

                const ctx = document.getElementById('incomeChart').getContext('2d');
                if (myChart) myChart.destroy(); // Ø­Ø°Ù Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ø°Ø§ ÙˆØ¬Ø¯

                myChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels.length ? labels : ['Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª'],
                        datasets: [{
                            label: 'Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø®ÙŠØ±Ø©',
                            data: values.length ? values : [0],
                            backgroundColor: '#3498db',
                            borderRadius: 5
                        }]
                    },
                    options: { scales: { y: { beginAtZero: true } } }
                });

            } catch (e) { console.error("Error loading dashboard:", e); }
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
        loadDashboardData();

    </script>
</body>
</html>