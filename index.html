<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ù†ØªØ± Ø§Ù„Ø´Ø§Ù…Ù„</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; text-align: center; background: #f0f2f5; color: #333; }
        .container { max-width: 480px; margin: 20px auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { color: #2c3e50; margin-bottom: 20px; }
        input, select { width: 100%; box-sizing: border-box; padding: 12px; margin: 8px 0; font-size: 16px; border: 2px solid #ddd; border-radius: 8px; text-align: center; transition: border 0.3s; background: #fff; }
        input:focus, select:focus { border-color: #007bff; outline: none; }
        button { width: 100%; padding: 12px; margin: 10px 0; font-size: 18px; color: white; border: none; border-radius: 8px; cursor: pointer; transition: 0.3s; font-weight: bold; }
        button:disabled { background-color: #ccc !important; cursor: not-allowed; }
        .btn-search { background: #007bff; } .btn-search:hover { background: #0056b3; }
        .btn-confirm { background: #28a745; } .btn-confirm:hover { background: #218838; }
        .btn-new-student { background: #6c757d; margin-top: 20px; font-size: 14px; padding: 8px; }
        .btn-edit { background: none; border: none; color: #ffc107; cursor: pointer; font-size: 20px; padding: 0 10px; transition: 0.3s; }
        .btn-delete { background: none; border: none; color: #dc3545; cursor: pointer; font-size: 20px; padding: 0 10px; transition: 0.3s; }
        .btn-edit:hover, .btn-delete:hover { transform: scale(1.2); }
        #result { margin-top: 20px; padding: 15px; border: 1px solid #e1e4e8; border-radius: 8px; background: #fafafa; display: none; }
        .info-tag { display: inline-block; padding: 5px 12px; background: #e9ecef; border-radius: 20px; margin: 5px; font-size: 0.95em; color: #555; }
        .price-label { display: block; margin-top: 15px; font-weight: bold; color: #333; }
        .recent-activity { margin-top: 30px; border-top: 2px solid #eee; padding-top: 20px; text-align: right; }
        .recent-activity h3 { font-size: 16px; color: #555; margin-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { padding: 8px; border-bottom: 1px solid #ddd; text-align: right; }
        th { background-color: #f8f9fa; color: #666; }
        .amount-col { color: #28a745; font-weight: bold; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 400px; border-radius: 12px; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; }
        .close-btn { position: absolute; left: 15px; top: 10px; color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .btn-save { background: #17a2b8; }
        .new-id-display { background: #d4edda; color: #155724; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #c3e6cb; display: none; font-weight: bold; }
        .field-label { display: block; text-align: right; font-size: 12px; color: #666; margin-top: 5px; margin-right: 5px; }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¹Ø§Ø¦Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
        #floatingTimer {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #2c3e50;
            color: #fff;
            padding: 8px 15px;
            border-radius: 25px;
            font-family: monospace;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 900;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }
    </style>
</head>
<body>

<div id="floatingTimer">
    <span>â±ï¸</span> <span id="timeDisplay">30:00</span>
</div>

<div class="container">
    <h2>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨</h2>
    
    <input type="text" id="studentCode" placeholder="Ø§Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø£Ùˆ Ø§ÙƒØªØ¨ Ø§Ù„ÙƒÙˆØ¯" autofocus autocomplete="off">
    <button class="btn-search" onclick="checkStudent()">ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨</button>
    <p class="loading" id="loader" style="display:none; color: #007bff;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</p>

    <div id="result">
        <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
            <h3 id="studentName" style="color: #2c3e50; margin: 0;"></h3>
            <button class="btn-edit" onclick="openEditModal()" title="ØªØ¹Ø¯ÙŠÙ„">âœï¸</button>
            <button class="btn-delete" onclick="deleteStudent()" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
        </div>

        <div style="margin-top: 10px;">
            <span id="studentGrade" class="info-tag" style="background:#e8f5e9; color:#2e7d32;"></span>
            <span id="studentGroup" class="info-tag" style="background:#fff3e0; color:#ef6c00;"></span>
        </div>
        <div>
            <span id="studentPhone" class="info-tag" style="background:#e3f2fd; color:#0d47a1;"></span>
        </div>
        <div id="parentPhoneDisplay" class="info-tag" style="background:#fff3cd; color:#856404; display:none; width: fit-content; margin: 10px auto;"></div>
        
        <label class="price-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:</label>
        <input type="number" id="priceField" inputmode="numeric">
        <button class="btn-confirm" onclick="confirmAttendance()">âœ… ØªØ£ÙƒÙŠØ¯ ÙˆØ¯ÙØ¹</button>
    </div>

    <div class="recent-activity">
        <h3>ğŸ“ Ø¢Ø®Ø± Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¯ÙØ¹</h3>
        <table id="activityTable">
            <thead>
                <tr>
                    <th>Ø§Ù„ÙƒÙˆØ¯</th>
                    <th>Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                    <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                    <th>Ø§Ù„ÙˆÙ‚Øª</th>
                </tr>
            </thead>
            <tbody id="activityBody"><tr><td colspan="4">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr></tbody>
        </table>
    </div>
</div>

<div style="display: flex; gap: 10px; margin-top: 20px;">
    <button class="btn-new-student" onclick="openModal()" style="flex: 1;">â• Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</button>
    <button class="btn-new-student" onclick="showDailyStats()" style="background: #6f42c1; flex: 1;">ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…</button>
</div>

<div id="addModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h3>Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
        <div class="new-id-display" id="generatedIdMsg"></div>
        <input type="text" id="new_name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ (Ø±Ø¨Ø§Ø¹ÙŠ)">
        <input type="tel" id="new_phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨">
        <input type="tel" id="new_parent_phone" placeholder="Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± ğŸ‘¨â€ğŸ‘¦"> 
        <label class="field-label">Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©:</label>
        <select id="new_grade">
            <option value="ØºÙŠØ± Ù…Ø­Ø¯Ø¯">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø© --</option>
            <option value="Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
            <option value="Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
            <option value="Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
        </select>
        <label class="field-label">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©:</label>
        <select id="new_group">
            <option value="Ø¹Ø§Ù…">Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¹Ø§Ù…Ø©</option>
            <option value="Ø§Ù„Ø³Ø¨Øª/Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡">Ø§Ù„Ø³Ø¨Øª / Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option>
            <option value="Ø§Ù„Ø£Ø­Ø¯/Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡">Ø§Ù„Ø£Ø­Ø¯ / Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option>
            <option value="Ø§Ù„Ø§Ø«Ù†ÙŠÙ†/Ø§Ù„Ø®Ù…ÙŠØ³">Ø§Ù„Ø§Ø«Ù†ÙŠÙ† / Ø§Ù„Ø®Ù…ÙŠØ³</option>
        </select>
        <label class="field-label">Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ:</label>
        <select id="new_sub_type" onchange="updateDefaultPrice()">
            <option value="per_class">Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ØµØ©</option>
            <option value="monthly">Ø§Ø´ØªØ±Ø§Ùƒ Ø´Ù‡Ø±ÙŠ</option>
        </select>
        <label class="field-label">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ:</label>
        <input type="number" id="new_price" value="80">
        <button class="btn-save" onclick="saveNewStudent()" id="saveBtn">ğŸ’¾ Ø­ÙØ¸ ÙˆØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯</button>
    </div>
</div>

<div id="editModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeEditModal()">&times;</span>
        <h3 style="color: #ffc107;">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª</h3>
        <input type="text" id="edit_name" placeholder="Ø§Ù„Ø§Ø³Ù…">
        <input type="tel" id="edit_phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨">
        <input type="tel" id="edit_parent_phone" placeholder="ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±">
        <input type="number" id="edit_price" placeholder="Ø§Ù„Ø³Ø¹Ø±">
        <button class="btn-save" onclick="saveEdit()" id="editBtn" style="background: #ffc107; color: #000;">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
    </div>
</div>

<div id="statsModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeStatsModal()">&times;</span>
        <h3 style="color: #6f42c1;">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…</h3>
        <div style="margin:20px 0; padding:15px; background:#f8f9fa; border-radius:10px;">
            <p>Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¶ÙˆØ±</p><h2 id="statsCount">0</h2>
        </div>
        <div style="margin:20px 0; padding:15px; background:#fff3cd; border-radius:10px;">
            <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„</p><h2 id="statsTotal">0 Ø¬.Ù…</h2>
        </div>
    </div>
</div>

<script>
    let currentStudentData = null;
    let confirmationWebhookUrl = ''; 

    // ==========================================
    // ğŸ”— Ø§Ù„Ø±ÙˆØ§Ø¨Ø·
    // ==========================================
    const SEARCH_URL = "https://n8ncourse.online/webhook/9e3b77e3-4f72-4e43-96ca-9a8bbfc70435"; 
    const PAY_URL    = "https://n8ncourse.online/webhook/35849c13-abde-4ffd-a0a9-a319e442e205"; 
    const ADD_URL    = "https://n8ncourse.online/webhook/8109b64b-de98-4323-bb17-19dba9466fb6";
    const RECENT_URL = "https://n8ncourse.online/webhook/recent-activity"; 
    const STATS_URL  = "https://n8ncourse.online/webhook/daily-stats"; 
    const UPDATE_URL = "https://n8ncourse.online/webhook/update-student"; 
    const DELETE_URL = "https://n8ncourse.online/webhook/delete-student"; 

    function updateDefaultPrice() {
        const type = document.getElementById('new_sub_type').value;
        const priceInput = document.getElementById('new_price');
        if (type === 'monthly') priceInput.value = 300; else priceInput.value = 80;
    }

    window.onload = function() {
        fetchRecentActivity();
        document.getElementById('studentCode').focus();
    };

    async function checkStudent() {
        const idInput = document.getElementById('studentCode');
        const id = idInput.value.trim();
        if(!id) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø£ÙˆÙ„Ø§Ù‹");
        
        document.getElementById('loader').style.display = 'block';
        document.getElementById('result').style.display = 'none';
        
        try {
            const response = await fetch(`${SEARCH_URL}?id=${id}`);
            let data = await response.json();
            if (Array.isArray(data)) data = data[0];
            const retrievedID = data.id || data.student_id;
            
            if (data && retrievedID) {
                document.getElementById('studentName').innerText = data.name;
                document.getElementById('studentGrade').innerText = data.grade_level || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
                document.getElementById('studentGroup').innerText = data.group_name || "Ø¹Ø§Ù…";
                document.getElementById('studentGrade').style.display = data.grade_level ? "inline-block" : "none";
                document.getElementById('studentPhone').innerText = data.phone ? "ğŸ“ " + data.phone : "";
                
                const pDisplay = document.getElementById('parentPhoneDisplay');
                pDisplay.innerText = data.parent_phone ? "ğŸ‘¨â€ğŸ‘¦ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±: " + data.parent_phone : "";
                pDisplay.style.display = data.parent_phone ? "block" : "none";

                // Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ø­ÙØ¸Ø©
                let baseCost = (data.subscription_type === 'monthly') ? 0 : (data.custom_rate || 80);
                let wallet = data.wallet_balance || 0;
                let requiredAmount = baseCost - wallet;
                if (requiredAmount < 0) requiredAmount = 0; 

                const priceLabel = document.querySelector('.price-label');
                if (wallet < 0) {
                    priceLabel.innerHTML = `Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: <span style="color:red; font-size:12px;">(Ø¹Ù„ÙŠÙ‡ Ø¯ÙŠÙ† Ù‚Ø¯ÙŠÙ…: ${Math.abs(wallet)} Ø¬.Ù…)</span>`;
                } else if (wallet > 0) {
                    priceLabel.innerHTML = `Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: <span style="color:green; font-size:12px;">(Ù„Ù‡ Ø±ØµÙŠØ¯ Ø³Ø§Ø¨Ù‚: ${wallet} Ø¬.Ù…)</span>`;
                } else {
                    priceLabel.innerHTML = `Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªØ­ØµÙŠÙ„Ù‡:`;
                }
                
                document.getElementById('priceField').value = requiredAmount;
                currentStudentData = { ...data, id: retrievedID };
                document.getElementById('result').style.display = 'block';
                document.getElementById('priceField').focus();

            } else {
                if(confirm("Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.. Ø¥Ø¶Ø§ÙØªÙ‡ØŸ")) { openModal(); }
                idInput.value = ''; idInput.focus();
            }
        } catch (error) { console.error(error); alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«"); } 
        finally { document.getElementById('loader').style.display = 'none'; }
    }

    async function saveNewStudent() {
        const name = document.getElementById('new_name').value;
        const price = document.getElementById('new_price').value;
        const grade = document.getElementById('new_grade').value;
        const group = document.getElementById('new_group').value;
        const subType = document.getElementById('new_sub_type').value;

        if (!name || !price) return alert("Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø³Ø¹Ø± Ù…Ø·Ù„ÙˆØ¨Ø§Ù†");

        const btn = document.getElementById('saveBtn');
        const originalText = btn.innerText;
        btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸..."; btn.disabled = true;

        try {
            const res = await fetch(ADD_URL, {
                method: "POST", headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 
                    name: name,
                    phone: document.getElementById('new_phone').value, 
                    parent_phone: document.getElementById('new_parent_phone').value, 
                    price: Number(price),
                    grade_level: grade,
                    group_name: group,
                    subscription_type: subType
                })
            });
            const data = await res.json();
            if (res.ok && data.id) {
                alert(`âœ… ØªÙ…! Ø§Ù„ÙƒÙˆØ¯: ${data.id}`);
                closeModal();
                document.getElementById('studentCode').value = data.id;
                checkStudent();
            } else { alert("âŒ Ø®Ø·Ø£"); }
        } catch (e) { alert("Ø®Ø·Ø£ Ø§ØªØµØ§Ù„"); } finally { btn.innerText = originalText; btn.disabled = false; }
    }

    async function confirmAttendance() {
        if (!currentStudentData) return;
        const price = Number(document.getElementById('priceField').value);
        const btn = document.querySelector('.btn-confirm');
        const originalText = btn.innerText;
        btn.innerText = "â³..."; btn.disabled = true;
        try {
            const res = await fetch(PAY_URL, {
                method: "POST", headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id: currentStudentData.id, amount: price })
            });
            const responseData = await res.json();
            if (responseData.status === "duplicate_warning") {
                confirmationWebhookUrl = responseData.Confirmation_Webhook_URL || responseData.confirmation_url;
                if(confirm("âš ï¸ Ø¯ÙØ¹ Ù…Ø³Ø¨Ù‚Ø§Ù‹! Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ØŸ")) {
                    await sendConfirmationRequest(currentStudentData.id, price, btn);
                } else { btn.innerText = originalText; btn.disabled = false; }
            } else if (responseData.status === "success" || res.ok) {
                showSuccessAndReset(`âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„!`);
                fetchRecentActivity(); 
            } else { alert("âŒ ÙØ´Ù„"); btn.innerText = originalText; btn.disabled = false; }
        } catch (e) { alert("Ø®Ø·Ø£ Ø§ØªØµØ§Ù„"); btn.innerText = originalText; btn.disabled = false; }
    }

    async function sendConfirmationRequest(id, amount, btnElement) {
        if (!confirmationWebhookUrl) return alert("Ø®Ø·Ø£ Ø±Ø§Ø¨Ø·");
        try {
            const res = await fetch(confirmationWebhookUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id, amount }) });
            if (res.ok) { showSuccessAndReset(`âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¤ÙƒØ¯!`); fetchRecentActivity(); } 
            else { alert("âŒ ÙØ´Ù„"); btnElement.innerText = "âœ… ØªØ£ÙƒÙŠØ¯"; btnElement.disabled = false; }
        } catch (e) { alert("Ø®Ø·Ø£"); } finally { confirmationWebhookUrl = ''; }
    }

    function showSuccessAndReset(msg) {
        alert(msg);
        document.getElementById('studentCode').value = "";
        document.getElementById('result').style.display = 'none';
        document.getElementById('studentCode').focus();
        const btn = document.querySelector('.btn-confirm');
        btn.innerText = "âœ… ØªØ£ÙƒÙŠØ¯ ÙˆØ¯ÙØ¹"; btn.disabled = false;
    }

    async function fetchRecentActivity() {
        if (RECENT_URL.includes("...")) return; 
        try {
            const res = await fetch(RECENT_URL);
            if (!res.ok) return;
            const data = await res.json();
            const tbody = document.getElementById('activityBody');
            tbody.innerHTML = ""; 
            if (data.length === 0) { tbody.innerHTML = "<tr><td colspan='4' style='text-align:center;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…</td></tr>"; return; }
            data.forEach(row => {
                const date = new Date(row.created_at);
                const timeStr = date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
                const studentName = row.student_name || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
                const studentCode = row.student_code || "---"; 
                tbody.innerHTML += `<tr>
                    <td style="font-weight:bold; color:#555;">${studentCode}</td>
                    <td>${studentName}</td>
                    <td class="amount-col">${row.amount} Ø¬.Ù…</td>
                    <td>${timeStr}</td>
                </tr>`;
            });
        } catch (e) { console.error(e); }
    }

    async function deleteStudent() {
        if (!currentStudentData || !currentStudentData.id) return;
        if (!confirm(`âš ï¸ Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨: "${currentStudentData.name}" Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ`)) return;
        const btn = document.querySelector('.btn-delete');
        btn.innerHTML = "â³"; btn.disabled = true;
        try {
            const res = await fetch(DELETE_URL, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ id: currentStudentData.id }) });
            if (res.ok) { alert("âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù."); document.getElementById('result').style.display = 'none'; document.getElementById('studentCode').value = ""; document.getElementById('studentCode').focus(); fetchRecentActivity(); } 
            else { alert("âŒ Ø®Ø·Ø£"); }
        } catch (e) { alert("Ø®Ø·Ø£"); } finally { btn.innerHTML = "ğŸ—‘ï¸"; btn.disabled = false; }
    }

    function openModal() { document.getElementById('addModal').style.display = "block"; }
    function closeModal() { document.getElementById('addModal').style.display = "none"; }
    function openEditModal() { document.getElementById('editModal').style.display = "block"; } 
    function closeEditModal() { document.getElementById('editModal').style.display = "none"; }
    function showDailyStats() { /* Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© */ }
    function closeStatsModal() { document.getElementById('statsModal').style.display = "none"; }
    window.onclick = function(e) { if (e.target.classList.contains('modal')) e.target.style.display = "none"; }
    
    document.getElementById("studentCode").addEventListener("keypress", function(e) { if (e.key === "Enter") checkStudent(); });
    document.getElementById("priceField").addEventListener("keypress", function(e) { if (e.key === "Enter") confirmAttendance(); });
</script>

<div id="timeoutWarning" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; justify-content: center; align-items: center;">
    <div style="background: white; padding: 40px; border-radius: 15px; text-align: center; border: 4px solid #dc3545; width: 320px; box-shadow: 0 0 20px rgba(220, 53, 69, 0.5);">
        <h1 style="font-size: 60px; margin: 0;">â³</h1>
        <h2 style="color: #dc3545; margin: 10px 0;">Ø§Ù†ØªØ¨Ù‡!</h2>
        <p style="font-size: 18px;">Ø³ØªÙ†ØªÙ‡ÙŠ Ø§Ù„Ø¬Ù„Ø³Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø®Ù„Ø§Ù„:</p>
        <h2 id="countdownTimer" style="font-size: 50px; color: #333; margin: 10px 0; font-family: monospace;">60</h2>
        <p style="font-size: 14px; color: #777;">Ø«Ø§Ù†ÙŠØ©</p>
    </div>
</div>

<script>
    // âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙˆÙ‚Øª
    const SESSION_DURATION = 30 * 60 * 1000; // 30 Ø¯Ù‚ÙŠÙ‚Ø©
    const WARNING_TIME = 60 * 1000;          // Ø¨Ø¯Ø¡ Ø¸Ù‡ÙˆØ± Ø§Ù„Ù†Ø§ÙØ°Ø© (Ø¢Ø®Ø± Ø¯Ù‚ÙŠÙ‚Ø©)
    const ALERT_SOUND_TIME = 15 * 1000;      // Ø¨Ø¯Ø¡ Ø§Ù„ØµÙˆØª (Ø¢Ø®Ø± 15 Ø«Ø§Ù†ÙŠØ©)

    // ğŸ”Š Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØµÙˆØª
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playWarningBeep() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        
        oscillator.type = 'square'; 
        oscillator.frequency.setValueAtTime(800, audioCtx.currentTime); 
        oscillator.frequency.exponentialRampToValueAtTime(400, audioCtx.currentTime + 0.1);
        
        gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);

        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        oscillator.start();
        oscillator.stop(audioCtx.currentTime + 0.2);
    }

    // ğŸ”„ Ø¯Ø§Ù„Ø© ÙØ­Øµ Ø§Ù„Ø¬Ù„Ø³Ø© + ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¹Ø§Ø¦Ù…
    function checkSession() {
        const role = sessionStorage.getItem("user_role");
        const startTime = sessionStorage.getItem("session_start");

        // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø³Ø¬Ù„Ø§Ù‹ØŒ Ø§Ø·Ø±Ø¯Ù‡ Ù„ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
        if (!role || !startTime) {
            window.location.href = "login.html";
            return;
        }

        const now = Date.now();
        const elapsedTime = now - startTime;
        const remainingTime = SESSION_DURATION - elapsedTime;

        // --- ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¹Ø§Ø¦Ù… (Ø§Ù„Ø¬Ø¯ÙŠØ¯) ---
        if (remainingTime > 0) {
            const minutes = Math.floor(remainingTime / 60000);
            const seconds = Math.floor((remainingTime % 60000) / 1000);
            const displayStr = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            document.getElementById('timeDisplay').innerText = displayStr;

            // ØªØºÙŠÙŠØ± Ø§Ù„Ù„ÙˆÙ† Ø¥Ø°Ø§ Ù‚Ù„ Ø¹Ù† 5 Ø¯Ù‚Ø§Ø¦Ù‚
            const floatingTimer = document.getElementById('floatingTimer');
            if (remainingTime < 5 * 60 * 1000) {
                floatingTimer.style.backgroundColor = '#c0392b'; // Ø£Ø­Ù…Ø± Ø¯Ø§ÙƒÙ†
                floatingTimer.style.border = '2px solid #e74c3c';
            } else {
                floatingTimer.style.backgroundColor = '#2c3e50'; // Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£ØµÙ„ÙŠ
                floatingTimer.style.border = '2px solid transparent';
            }
        }

        // 1. Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª
        if (remainingTime <= 0) {
            sessionStorage.clear();
            alert("ğŸ›‘ Ø§Ù†ØªÙ‡Øª Ù…Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø© (30 Ø¯Ù‚ÙŠÙ‚Ø©).\nÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
            window.location.href = "login.html";
        } 
        // 2. Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ­Ø°ÙŠØ± (Popup)
        else if (remainingTime <= WARNING_TIME) {
            document.getElementById('timeoutWarning').style.display = 'flex';
            const secondsLeft = Math.ceil(remainingTime / 1000);
            document.getElementById('countdownTimer').innerText = secondsLeft;
            
            if (secondsLeft <= 10) {
                document.getElementById('countdownTimer').style.color = "red";
            }

            if (remainingTime <= ALERT_SOUND_TIME) {
                playWarningBeep();
            }
        }
    }

    // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙØ­Øµ ÙƒÙ„ Ø«Ø§Ù†ÙŠØ©
    setInterval(checkSession, 1000);
    checkSession(); // ØªØ´ØºÙŠÙ„ ÙÙˆØ±ÙŠ

    // Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ (ÙŠØ³ØªØ®Ø¯Ù…Ù‡ Ø§Ù„Ø²Ø± ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± Ø¥Ù† ÙˆØ¬Ø¯ØŒ Ø£Ùˆ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡)
    function logout() {
        if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) {
            sessionStorage.clear();
            window.location.href = "login.html";
        }
    }
</script>

</body>
</html>