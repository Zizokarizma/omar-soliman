<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ù†ØªØ± Ø§Ù„Ø´Ø§Ù…Ù„</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; text-align: center; background: #f0f2f5; }
        .container { max-width: 480px; margin: 20px auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { color: #333; margin-bottom: 20px; }
        
        input { 
            width: 100%; box-sizing: border-box; padding: 12px; margin: 8px 0; 
            font-size: 16px; border: 2px solid #ddd; border-radius: 8px; text-align: center; 
        }
        input:focus { border-color: #007bff; outline: none; }
        
        button { 
            width: 100%; padding: 12px; margin: 10px 0; font-size: 18px; 
            color: white; border: none; border-radius: 8px; cursor: pointer; transition: 0.3s; 
        }
        .btn-search { background: #007bff; }
        .btn-search:hover { background: #0056b3; }
        
        .btn-confirm { background: #28a745; }
        .btn-confirm:hover { background: #218838; }

        .btn-new-student { background: #6c757d; margin-top: 20px; font-size: 14px; padding: 8px; }
        .btn-new-student:hover { background: #5a6268; }

        #result { margin-top: 20px; padding: 15px; border: 1px solid #e1e4e8; border-radius: 8px; background: #fafafa; display: none; }
        .loading { color: #007bff; font-weight: bold; display: none; margin-top: 10px; }
        .info-tag { display: inline-block; padding: 5px 10px; background: #e9ecef; border-radius: 20px; margin-bottom: 5px; font-size: 0.9em; color: #555; margin-left: 5px; }
        .price-label { display: block; margin-top: 15px; font-weight: bold; color: #333; }

        /* Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888;
            width: 90%; max-width: 400px; border-radius: 10px; position: relative;
        }
        .close-btn {
            position: absolute; left: 15px; top: 10px; color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer;
        }
        .btn-save { background: #17a2b8; }
        .btn-save:hover { background: #138496; }
    </style>
</head>
<body>

<div class="container">
    <h2>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨</h2>
    
    <input type="text" id="studentCode" placeholder="Ø§Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø£Ùˆ Ø§ÙƒØªØ¨ Ø§Ù„ÙƒÙˆØ¯" autofocus>
    <button class="btn-search" onclick="checkStudent()">ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨</button>

    <p class="loading" id="loader">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</p>

    <div id="result">
        <h3 id="studentName" style="color: #2c3e50; margin: 0 0 10px 0;"></h3>
        
        <div>
            <span id="studentInfo" class="info-tag"></span>
            <span id="studentPhone" class="info-tag" style="background:#e3f2fd; color:#0d47a1;"></span>
        </div>
        <div id="parentPhoneDisplay" class="info-tag" style="background:#fff3cd; color:#856404; display:block; margin-top:5px;"></div>
        
        <label class="price-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªØ­ØµÙŠÙ„Ù‡:</label>
        <input type="number" id="priceField">
        
        <button class="btn-confirm" onclick="confirmAttendance()">âœ… ØªØ£ÙƒÙŠØ¯ ÙˆØ¯ÙØ¹</button>
    </div>

    <button class="btn-new-student" onclick="openModal()">â• Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</button>
</div>

<div id="addModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h3>Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
        
        <input type="number" id="new_id" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ (Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯)">
        <input type="text" id="new_name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨">
        <input type="text" id="new_phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨">
        <input type="text" id="new_parent_phone" placeholder="Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± ğŸ‘¨â€ğŸ‘¦"> 
        <input type="text" id="new_info" placeholder="Ø§Ù„Ø«Ù…Ù† Ø§Ù„Ù…Ø¯ÙÙˆØ¹">
        <input type="number" id="new_price" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø­ØµØ© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ">
        
        <button class="btn-save" onclick="saveNewStudent()" id="saveBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    </div>
</div>

<script>
    // ============================================================
    // ğŸ›‘ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù€ n8n Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ
    // ============================================================
    const SEARCH_URL = "https://n8ncourse.online/webhook/9e3b77e3-4f72-4e43-96ca-9a8bbfc70435"; 
    const PAY_URL    = "https://n8ncourse.online/webhook/35849c13-abde-4ffd-a0a9-a319e442e205"; 
    const ADD_URL    = "https://n8ncourse.online/webhook/8109b64b-de98-4323-bb17-19dba9466fb6"; 
    // ============================================================

    let currentStudentData = null;

    async function checkStudent() {
        const id = document.getElementById('studentCode').value.trim();
        if(!id) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø£ÙˆÙ„Ø§Ù‹");

        document.getElementById('loader').style.display = 'block';
        document.getElementById('result').style.display = 'none';

        try {
            const response = await fetch(`${SEARCH_URL}?id=${id}`);
            let data = await response.json();
            if (Array.isArray(data)) data = data[0];

            if (data && (data.name || data.student_id)) {
                document.getElementById('studentName').innerText = data.name;

                // -----------------------------------------------------
                // ğŸ’¡ ÙƒÙˆØ¯ ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¹Ø±
                // -----------------------------------------------------
                let displayText = data.info; 

                if (data.price == 80) {
                    displayText = "â­ Ø·Ø§Ù„Ø¨ Ø­ØµØ©";
                } 
                else if (!displayText) {
                    displayText = ""; 
                }
                
                document.getElementById('studentInfo').innerText = displayText;
                // -----------------------------------------------------

                document.getElementById('studentPhone').innerText = data.phone ? "ğŸ“ " + data.phone : "";
                
                // Ø¹Ø±Ø¶ Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±
                const pPhone = data.parent_phone;
                const pDisplay = document.getElementById('parentPhoneDisplay');
                if(pPhone) {
                    pDisplay.innerText = "ğŸ‘¨â€ğŸ‘¦ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±: " + pPhone;
                    pDisplay.style.display = "block";
                } else {
                    pDisplay.style.display = "none";
                }

                document.getElementById('priceField').value = data.price;
                currentStudentData = data;
                document.getElementById('result').style.display = 'block';
            } else {
                if(confirm("Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¶Ø§ÙØªÙ‡ Ø§Ù„Ø¢Ù†ØŸ")) {
                    openModal();
                    document.getElementById('new_id').value = id;
                }
            }
        } catch (error) {
            console.error(error);
            alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„");
        } finally {
            document.getElementById('loader').style.display = 'none';
        }
    }

    // ============================================================
    // ğŸ”¥ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø©: ØªÙÙ‡Ù… Ø§Ù„ØªÙƒØ±Ø§Ø± ÙˆØªØ±Ø³Ù„ force Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
    // ============================================================
    async function confirmAttendance(force = false) {
        if (!currentStudentData) return;
        
        const price = document.getElementById('priceField').value;
        const btn = document.querySelector('.btn-confirm');
        
        // ØªØºÙŠÙŠØ± Ù†Øµ Ø§Ù„Ø²Ø± Ù„ÙŠÙˆØ¶Ø­ Ø§Ù„Ø­Ø§Ù„Ø©
        btn.innerText = force ? "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙƒØ±Ø§Ø±..." : "â³..."; 
        btn.disabled = true;

        const payload = { 
            id: currentStudentData.student_id || currentStudentData.id, 
            amount: price 
        };
        
        // Ø¥Ø°Ø§ Ø¶ØºØ· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "Ù†Ø¹Ù…" ÙÙŠ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±ØŒ Ù†Ø±Ø³Ù„ Ø£Ù…Ø± Ø§Ù„Ù‚ÙˆØ©
        if (force) payload.force = true;

        try {
            const res = await fetch(PAY_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø±Ø¯ ÙƒÙ€ JSON Ù„ÙØ­Øµ Ø­Ø§Ù„Ø© duplicate
            const responseData = await res.json();

            // Ø§Ù„Ø­Ø§Ù„Ø© 1: Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§ÙƒØªØ´Ù ØªÙƒØ±Ø§Ø±Ø§Ù‹ ÙˆØ±Ø¯ Ø¨Ø±Ø³Ø§Ù„Ø© "duplicate"
            if (responseData.status === "duplicate") {
                // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®
                const dateObj = new Date(responseData.date);
                const dateStr = dateObj.toLocaleDateString('ar-EG');
                const timeStr = dateObj.toLocaleTimeString('ar-EG');

                // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù…Ø¹ Ø®ÙŠØ§Ø±ÙŠÙ† (Ù…ÙˆØ§ÙÙ‚ / Ø¥Ù„ØºØ§Ø¡)
                const userAgreed = confirm(
                    `âš ï¸ ØªÙ†Ø¨ÙŠÙ‡ Ù‡Ø§Ù…!\nÙ‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¯ÙØ¹ Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹.\n` +
                    `Ø¨ØªØ§Ø±ÙŠØ®: ${dateStr} Ø§Ù„Ø³Ø§Ø¹Ø©: ${timeStr}\n\n` +
                    `Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„Ù‡ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ (Ø¯ÙØ¹ Ø¬Ø¯ÙŠØ¯)ØŸ`
                );

                if (userAgreed) {
                    // Ø¥Ø°Ø§ ÙˆØ§ÙÙ‚ØŒ Ù†Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¹ ØªÙØ¹ÙŠÙ„ "force"
                    confirmAttendance(true);
                }
            } 
            // Ø§Ù„Ø­Ø§Ù„Ø© 2: Ù†Ø¬Ø§Ø­ Ø¹Ø§Ø¯ÙŠ (Ù„Ù… ÙŠØ¬Ø¯ ØªÙƒØ±Ø§Ø±Ø§Ù‹ Ø£Ùˆ ØªÙ… Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±)
            else if (res.ok) { 
                alert(`âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ù€: ${currentStudentData.name}`);
                location.reload();
            } 
            else {
                alert("âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ");
            }

        } catch (e) { 
            console.error(e);
            alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±"); 
        }
        finally { 
            btn.innerText = "âœ… ØªØ£ÙƒÙŠØ¯ ÙˆØ¯ÙØ¹"; 
            btn.disabled = false; 
        }
    }

    // --- Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ---
    async function saveNewStudent() {
        const id = document.getElementById('new_id').value;
        const name = document.getElementById('new_name').value;
        const phone = document.getElementById('new_phone').value;
        const parent_phone = document.getElementById('new_parent_phone').value; 
        const info = document.getElementById('new_info').value;
        const price = document.getElementById('new_price').value;

        if (!id || !name || !price) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©");

        const btn = document.getElementById('saveBtn');
        btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸..."; btn.disabled = true;

        try {
            const res = await fetch(ADD_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id, name, phone, parent_phone, info, price }) 
            });

            if (res.ok) {
                alert("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!");
                closeModal();
                document.getElementById('studentCode').value = id;
                checkStudent(); 
            } else {
                alert("âŒ Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸");
            }
        } catch (e) { alert("Ø®Ø·Ø£ Ø§ØªØµØ§Ù„"); }
        finally { btn.innerText = "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"; btn.disabled = false; }
    }

    function openModal() { document.getElementById('addModal').style.display = "block"; }
    function closeModal() { document.getElementById('addModal').style.display = "none"; }
    window.onclick = function(e) { if (e.target == document.getElementById('addModal')) closeModal(); }
    
    document.getElementById("studentCode").addEventListener("keypress", function(e) {
        if (e.key === "Enter") checkStudent();
    });
</script>

</body>
</html>